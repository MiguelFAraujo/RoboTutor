{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <title>RoboTutor - Aprenda Arduino</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button onclick="startNewChat()" class="new-chat-btn">
                    <span>+</span> Nova Conversa
                </button>
            </div>

            <div class="history-list">
                {% for conv in conversations %}
                <a onclick="loadConversation({{ conv.id }})" class="history-item" id="conv-{{ conv.id }}">
                    {{ conv.title }}
                </a>
                {% endfor %}
            </div>

            <div class="user-profile">
                <div style="font-size: 0.8rem; color: #94a3b8;">
                    {{ user.email }}<br>
                    <a href="{% url 'logout' %}" style="color: #6366f1;">Sair</a>
                </div>
            </div>
        </aside>

        <main class="chat-interface">
            <header class="chat-header">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1>ü§ñ RoboTutor <span>AI</span></h1>

                <div style="font-size: 0.85rem; margin-top: 5px; color: #94a3b8;">
                    {% if is_premium %}
                    <span
                        style="background: #6366f1; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">PREMIUM
                        üëë</span>
                    | Cr√©ditos: <strong>{{ remaining }}/{{ limit }}</strong>
                    {% else %}
                    <span
                        style="background: #334155; color: #cbd5e1; padding: 2px 6px; border-radius: 4px;">GR√ÅTIS</span>
                    <a href="{% url 'subscribe' %}"
                        style="display: inline-block; background: #22c55e; color: white; text-decoration: none; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; margin-left: 5px;">
                        Assinar Premium (R$ 4,99/sem) üöÄ
                    </a>
                    <div style="margin-top: 4px; font-size: 0.75rem;">Cr√©ditos: <strong>{{ remaining }}/{{ limit
                            }}</strong></div>
                    {% endif %}
                </div>
            </header>

            <div id="chat-messages" class="chat-messages">
                <div class="message bot">
                    Ol√°! Sou o Miguel, seu instrutor de rob√≥tica. O que vamos construir hoje? üõ†Ô∏è
                </div>
            </div>

            <div class="chat-input-area">
                <form class="input-form" onsubmit="handleFormSubmit(event)">
                    {% csrf_token %}
                    <input type="text" id="user-input" class="chat-input" placeholder="Pergunte sobre Arduino..."
                        aria-label="Sua mensagem" autocomplete="off">
                    <button type="submit" class="send-button" aria-label="Enviar mensagem">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script>
        let currentConversationId = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function startNewChat() {
            currentConversationId = null;
            document.getElementById('chat-messages').innerHTML = `
                <div class="message bot">
                    Ol√°! Sou o Miguel, seu instrutor de rob√≥tica. O que vamos construir hoje? üõ†Ô∏è
                </div>`;
            // Remove active class from sidebar items
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            if (window.innerWidth <= 768) toggleSidebar();
        }

        async function loadConversation(id) {
            currentConversationId = id;
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '<div style="text-align:center; color:#666;">Carregando...</div>';

            // Highlight active
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`conv-${id}`);
            if (activeItem) activeItem.classList.add('active');

            try {
                const response = await fetch(`/history/${id}/`);
                const data = await response.json();

                chatBox.innerHTML = '';
                if (data.messages) {
                    data.messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `message ${msg.role === 'user' ? 'user' : 'bot'}`;
                        div.innerHTML = msg.role === 'user' ? msg.content : marked.parse(msg.content);
                        chatBox.appendChild(div);
                    });
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {
                chatBox.innerHTML = '<div style="color:red">Erro ao carregar conversa.</div>';
            }

            if (window.innerWidth <= 768) toggleSidebar();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-messages');
            const text = input.value.trim();

            if (!text) return;

            chatBox.innerHTML += `<div class="message user">${text}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'message bot';
            botMessageDiv.innerHTML = 'Pensando... ü§î';
            chatBox.appendChild(botMessageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        conversation_id: currentConversationId
                    })
                });

                // Get updated conversation ID if new
                const serverConvId = response.headers.get('X-Conversation-Id');
                if (serverConvId && !currentConversationId) {
                    currentConversationId = serverConvId;
                    // Ideally refresh sidebar here, but for now user can refresh page to see title
                }

                if (response.status === 403) {
                    const data = await response.json();
                    botMessageDiv.innerHTML = marked.parse(data.response);
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = "";
                botMessageDiv.innerHTML = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedText += chunk;
                    botMessageDiv.innerHTML = marked.parse(accumulatedText);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

            } catch (error) {
                botMessageDiv.innerHTML = "‚ùå Erro ao conectar com o c√©rebro do rob√¥.";
            }
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            sendMessage();
        }
    </script>
</body>